// app/plugins/forensik.bab7.darjat.card.tsx
// Bab 7 â€” Darjat al-Ism (ikut kitab 1â€“4/5) + Rujukan Darjat Asal Unsur (bukan ikut nama).
// Kiraan Darjat al-Ism: jumlah Abjad Kabir (nama Arab) % 5; baki 0 dianggap 5.

import React, { useMemo, useState } from "react";
import { ScrollView, View, Text, TextInput, StyleSheet } from "react-native";
import Accordion from "../components/Accordion";

/* Nilai Abjad Kabir */
const ABJAD: Record<string, number> = {
  "Ø§":1,"Ø¨":2,"Ø¬":3,"Ø¯":4,"Ù‡":5,"Ùˆ":6,"Ø²":7,"Ø­":8,"Ø·":9,
  "ÙŠ":10,"Ùƒ":20,"Ù„":30,"Ù…":40,"Ù†":50,"Ø³":60,"Ø¹":70,"Ù":80,"Øµ":90,
  "Ù‚":100,"Ø±":200,"Ø´":300,"Øª":400,"Ø«":500,"Ø®":600,"Ø°":700,"Ø¶":800,"Ø¸":900,"Øº":1000,
  // Varian lazim
  "Ø£":1,"Ø¥":1,"Ø¢":1,"Ø©":5,"Ù‰":10,"Ø¤":6,"Ø¦":10,"Ù„Ø§":31
};

/* Label darjat Arab */
const DARJAT_AR = {1:"Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰",2:"Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©",3:"Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©",4:"Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©",5:"Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø§Ù…Ø³Ø©"} as const;

/* Util asas */
function jumlahAbjad(raw:string){
  const s=(raw||"").replace(/\s+/g,"");
  let total=0;
  for(let i=0;i<s.length;i++){
    if(i+1<s.length && s[i]==="Ù„" && s[i+1]==="Ø§"){ total+=31; i++; continue; }
    total += ABJAD[s[i]] || 0;
  }
  return total;
}
function unsurGhalibRingkas(raw:string):"Api"|"Udara"|"Air"|"Tanah"{
  const s=(raw||"").replace(/\s+/g,"");
  let max=0;
  for(const ch of s){ max=Math.max(max, ABJAD[ch]||0); }
  if(max>=400) return "Api";
  if(max>=100) return "Tanah";
  if(max>=40)  return "Udara";
  return "Air";
}

/* Rujukan Darjat Asal Unsur â€” hanya apa yang memang dinyatakan dalam petikan (tiada rekaan) */
const RUJUKAN_DARJAT_ASAL = {
  Api: [
    { ar:"Ù‡ÙˆØ§Ø¡ Ø§Ù„Ù†Ø§Ø± â€” ØªØ§Ø±ÙŒ Ù…Ø³ØªÙˆÙ‚Ø¯", ms:"Udara Api â€” â€œtÄr mustawqidâ€", info:"Ø­Ø±ÙˆÙ=28 â€¢ Ø¹Ø¯Ø¯=3969" },
    { ar:"Ù†Ø§Ø±ÙŒ ØªØ£ÙƒÙ„ ÙˆØªØ´Ø±Ø¨",           ms:"Api yang makan & minum",     info:"Ø­Ø±ÙˆÙ=66 â€¢ Ø¹Ø¯Ø¯=30"  },
  ],
  Udara: [
    // Kitab nyatakan 3â€“5; nilai yang disebut sahaja dipaparkan
    { ar:"Ù‡ÙˆØ§Ø¡ Ø§Ù„Ø¹Ø´Ù‚ ÙˆØ§Ù„Ù…Ø­Ø¨Ø©",         ms:"Udara kasih & cinta",         info:"Ø­Ø±ÙˆÙ=66"  },
    { ar:"Ø¬Ù…Ø¹ Ø§Ù„Ø·ÙŠÙˆØ±",                 ms:"Pengumpulan burung-burung",   info:"Ø­Ø±ÙˆÙ=436" },
    { ar:"Ù‡ÙˆØ§Ø¡ Ø¨Ø§Ø±Ø¯ Ù…ÙØ³Ø¯",            ms:"Udara sejuk yang merosakkan", info:"Ø¹Ø¯Ø¯=500"  },
  ],
  Air: [
    { ar:"Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„Ø¹Ø°Ø¨ Ø§Ù„ÙØ±Ø§Øª",         ms:"Air tawar yang manis",         info:"Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø±ÙˆÙ=94409" },
    { ar:"Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„Ù…Ø±Ù‘ Ø§Ù„ØªÙŠÙ†",          ms:"Air pahit yang keras",         info:"Ø­Ø±ÙˆÙ=73"          },
    { ar:"Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„Ø²ÙØ¹Ø§Ù‚",              ms:"Air masin yang kuat",          info:"Ø­Ø±ÙˆÙ=41972"       },
    { ar:"Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„ÙˆØ¯Ù‚ Ø§Ù„Ø°ÙŠ Ù„Ø§ Ø·Ø¹Ù… Ù„Ù‡", ms:"Air hujan tiada rasa",         info:"Ø­Ø±ÙˆÙ=94"          },
    { ar:"Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„Ø«Ù‚ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø³Ø§Ù†",   ms:"Air yang berat atas manusia",  info:"Ø¨Ø³Ø·=93"           },
  ],
  Tanah: [
    { ar:"ØªØ±Ø§Ø¨ Ø§Ù„Ø­Ø¨Ù‘ ÙˆØ§Ù„Ø²Ø±Ø¹",          ms:"Tanah cinta & tanaman",        info:"Ø¨Ø³Ø·=2941 â€¢ Ø£Ø¹Ø¯Ø§Ø¯=3124" },
    { ar:"ØªØ±Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù†",               ms:"Tanah logam & galian",         info:"Ø£Ø¹Ø¯Ø§Ø¯=314"             },
    { ar:"Ø§Ù„ØªØ±Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ¹Ù…Ù„",            ms:"Tanah yang digunakan",         info:"Ø¨Ø³Ø·=118"               },
    { ar:"ØªØ±Ø§Ø¨ Ø§Ù„Ø³Ù‘ÙØ¨Ø§Ø­ Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØ·Ù„Ø¹ ÙÙŠÙ‡ Ù†Ø¨Ø§Øª", ms:"Tanah tandus",        info:"Ø¨Ø³Ø·=19141"             },
  ],
} as const;

function Card(){
  const [nama,setNama]=useState("Ù…ÙˆÙ†ÙŠØ±");

  const R = useMemo(()=>{
    const jumlah = jumlahAbjad(nama);
    const mod5   = jumlah % 5;
    const darjat = mod5 === 0 ? 5 : mod5; // 1â€“4/5
    const darjatAr = DARJAT_AR[darjat as 1|2|3|4|5];
    const unsur = unsurGhalibRingkas(nama); // rujukan ringkas, tak ubah formula kitab lain
    return { jumlah, mod5, darjat, darjatAr, unsur };
  },[nama]);

  return (
    <ScrollView contentContainerStyle={{padding:14}}>
      <Text style={st.h1}>Bab 7 â€” Darjat al-Ism (ikut nama)</Text>
      <Text style={st.sub}>
        Kiraan kitab: jumlah Abjad Kabir (huruf Arab) % 5 â†’ 1â€“4; baki 0 = 5. 
        Darjat ini mengikut nama, bukan darjat unsur asal.
      </Text>

      <Accordion title="Nama" defaultOpen={false}>
        <Text style={st.label}>Nama (huruf Arab):</Text>
        <TextInput value={nama} onChangeText={setNama} style={st.input}/>
      </Accordion>

      <Accordion title="Keputusan Darjat al-Ism (ikut nama)" defaultOpen={false}>
        <View style={st.card}>
          <Text style={st.row}>Jumlah Abjad: <Text style={st.hi}>{R.jumlah}</Text></Text>
          <Text style={st.row}>Baki mod 5: <Text style={st.hi}>{R.mod5}</Text> <Text style={st.dim}>(0 â†’ 5)</Text></Text>
          <Text style={st.row}>Darjat: <Text style={st.hi}>Darjat {R.darjat}</Text> <Text style={st.dim}>â€” {R.darjatAr}</Text></Text>
          <Text style={st.row}>Unsur ghalib (ringkas): <Text style={st.hi}>{R.unsur}</Text></Text>
          <Text style={st.tipAr}>Â«ØªÙØ¬Ù…Ø¹ Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø±ÙˆÙ Ø«Ù… ÙŠÙØ·Ø±Ø­ Ø¹Ù„Ù‰ Ø®Ù…Ø³Ø©Ø› ÙØ¥Ù† Ø¨Ù‚ÙŠ ÙˆØ§Ø­Ø¯ ÙØ§Ù„Ø£ÙˆÙ„Ù‰ â€¦ ÙˆØ¥Ù† Ù„Ù… ÙŠØ¨Ù‚ Ø´ÙŠØ¡ ÙÙ‡ÙŠ Ø§Ù„Ø®Ø§Ù…Ø³Ø©Â»</Text>
        </View>
      </Accordion>

      <Accordion title="Rujukan â€” Darjat Asal Unsur (bukan ikut nama)" defaultOpen={false}>
        <View style={st.refBlock}>
          <Text style={st.refHead}>ğŸ”¥ Api â€” 2 darjat (yang dinyatakan)</Text>
          {RUJUKAN_DARJAT_ASAL.Api.map((x,i)=>(
            <Text key={"a"+i} style={st.refLine}>â€¢ {x.ar} â€” {x.ms} <Text style={st.dim}>[{x.info}]</Text></Text>
          ))}

          <Text style={st.refHead}>ğŸ’¨ Udara â€” darjat 3â€“5 (yang dinyatakan)</Text>
          {RUJUKAN_DARJAT_ASAL.Udara.map((x,i)=>(
            <Text key={"u"+i} style={st.refLine}>â€¢ {x.ar} â€” {x.ms} <Text style={st.dim}>[{x.info}]</Text></Text>
          ))}

          <Text style={st.refHead}>ğŸ’§ Air â€” 5 darjat (lengkap)</Text>
          {RUJUKAN_DARJAT_ASAL.Air.map((x,i)=>(
            <Text key={"w"+i} style={st.refLine}>â€¢ {x.ar} â€” {x.ms} <Text style={st.dim}>[{x.info}]</Text></Text>
          ))}

          <Text style={st.refHead}>ğŸŒ Tanah â€” 4 darjat (lengkap)</Text>
          {RUJUKAN_DARJAT_ASAL.Tanah.map((x,i)=>(
            <Text key={"t"+i} style={st.refLine}>â€¢ {x.ar} â€” {x.ms} <Text style={st.dim}>[{x.info}]</Text></Text>
          ))}
        </View>
      </Accordion>
    </ScrollView>
  );
}

/* Gaya */
const st = StyleSheet.create({
  h1:{color:"#e8e6e3",fontSize:18,fontWeight:"900"},
  sub:{color:"#9a9692",marginTop:4,marginBottom:8},
  label:{color:"#e8e6e3",fontWeight:"800"},
  input:{color:"#e8e6e3",borderWidth:1,borderColor:"#333",borderRadius:8,padding:10,marginTop:6},
  card:{borderWidth:1,borderColor:"#333",borderRadius:12,padding:12,gap:6},
  row:{color:"#e8e6e3",marginVertical:2},
  hi:{color:"#7bd88f",fontWeight:"800"},
  dim:{color:"#b3aca7"},
  tipAr:{color:"#9a9692",marginTop:8,fontStyle:"italic"},
  refBlock:{borderWidth:1,borderColor:"#333",borderRadius:12,padding:12,gap:6},
  refHead:{color:"#e8e6e3",fontWeight:"900",marginTop:8,marginBottom:4},
  refLine:{color:"#e8e6e3",marginLeft:6,marginVertical:2},
});

/* Adapter (ikut gaya standard projek) */
const ForensikBab7DarjatIsm = {
  id: "forensik-bab7-darjat-ism",
  label: "Bab 7 â€” Darjat al-Ism (mod 5)",
  render: Card,
};
export default ForensikBab7DarjatIsm;
